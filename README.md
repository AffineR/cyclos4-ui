# Cyclos 4 user interface

<img src="cyclos.png" align="right" width="120" alt="Cyclos"/>
This project aims to create a modern, simple and intuitive user interface for [Cyclos](https://www.cyclos.org/) version 4.11 and up. The interface should be easy to customize and add functionality needed by specific projects.

The initial planned scope is to have only end-user functionality in this application. Administration functionality will still be available in Cyclos' default web interface.

## Technical details

- This application is built using [Angular](https://angular.io/) and [Bootstrap](https://getbootstrap.com), using the [ngx-bootstrap](https://valor-software.com/ngx-bootstrap/) integration library;
- It uses Cyclos' REST API for integration. The [ng-swagger-gen](https://github.com/cyclosproject/ng-swagger-gen) project is used to generate the client services and web service models;
- Translations are done separatedly from the Cyclos installation. This way they cannot be customized in Cyclos, but allows the user interface to grow independently from the deployed Cyclos version;
- Requests to the Cyclos server are performed directly from the browser. That means that either this front-end should be deployed in the same domain as Cyclos, or CORS should be enabled in Cyclos by setting `cyclos.cors.origin = <cyclos4-ui-domain>` in the `cyclos.properties` file.

## Status
This is a project is not yet stable, and shouldn't be used on production until it reaches the `1.0` version.

## Implemented functionality
This frontend implements the following functionality:

- User access: login, logout, forgot password, login with expired password, login with pending agreements (no support for secondary access password);
- Account history, transfer details;
- Perform payment both to user and system, supports direct, scheduled and recurring payments, indicates if a payment needs authorization;
- Search scheduled / recurring / authorized payments;
- Search users (called business directory, as most systems only allow searching businesses);
- View user profile, with a few actions (perform payment and add to contact list);
- Contact list;
- Manage passwords (change, generate new, unblock, disable / enable);
- Edit own profile (images, basic / custom fields, phones, addresses and additional contact information);
- Public user registration;
- Search advertisements, advertisement details (no shopping cart so far).

More functionality will be added in future versions.

## Requirements

- [Cyclos](https://www.cyclos.org/) version 4.11+ (for the backend);
- [NodeJS](https://nodejs.org/) version 8+;
- [NPM](https://www.npmjs.com/) version 5+.

## Getting and preparing the code

First, make sure you have cloned the repository, the current working directory is `cyclos4-ui` and the NPM dependencies are installed (might take a while the first time to download all dependencies):
```bash
git clone https://github.com/cyclosproject/cyclos4-ui.git
cd cyclos4-ui
npm install
```

The project will not compile yet because it depends on classes which are generated by [ng-swagger-gen](https://github.com/cyclosproject/ng-swagger-gen).

## Setting the Cyclos server URL
On the `src/environments/configuration.ts` you will find the file that needs to be configured for your project.
The most important settings are the following:
```typescript
// The root URL for the API. Either 'api' when using a proxy, or the full URL (with protocol) to the Cyclos backend, ending with /api. See below on 'Access to the API backend'.
const API_URL = 'http://localhost:8888/api';
// Application title
const APP_TITLE = 'Cyclos Local';
// Application title on small devices (constrained space)
const APP_TITLE_SMALL = 'Cyclos';
// The application title displayed on the title bar inside the menu on small devices
const APP_TITLE_MENU = 'Cyclos menu';
```

## Debugging
To start the development server, with hot reload, which should be accessible at http://localhost:4200/, run the following command:
```bash
npm start
```

## Building
Once you have the configuration set, you can build the user interface by typing:
```bash
npm run build
```

After the build process (which can take a few minutes) you will have the `dist` directory containing the resources that should be deployed to your web server (Apache, Nginx, etc).

Angular assumes the application is deployed in the root path of your domain. For example, this is the case for `https://account.example.org`. If this is not the case, such as `https://www.example.org/path` you need to pass in the path name to Angular at compilation time, like:
```bash
# Replace /path/ with your base path. Don't forget both leading and trailing slashes.
npm run build -- --base-href /path/
```

## Deploying to the server
Angular, by default, uses `HTML5`'s [history.pushState](https://developer.mozilla.org/en-US/docs/Web/API/History_API#The_pushState()_method) method, which produces URLs with paths which are undistinguishable from regular nested paths, but without producing a new request. Besides producing natural URLs, this method allows future expansions, such as using [server-side rendering](https://angular.io/guide/universal).

In order to correctly support the application, the server must also respond to deep links, even if they don't physically exist on the server. For example, if the frontend is deployed on `https://account.example.org`, and the user clicks on the pay user menu, he will see the URL `https://account.example.org/banking/payment`. However, there is no `banking/payment` directory in the generated folder (`dist`). Without specific configuration, clicking directly on that link, or refreshing the browser page while in this URL would present a `404` error page.

To solve this problem the server must include the `index.html` content on any request to files that don't physically exist on the server. For Apache, make sure the `mod_rewrite` is enabled, and the following configuration is applied:

```apache
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.html$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.html [L]
</IfModule>
```

However, if the application is deployed in a sub path, then both `RewriteBase` and `RewriteRule` must be changed, like this (assuming `/path`):

```apache
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /path/
  RewriteRule ^index\.html$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /path/index.html [L]
</IfModule>
```

If you deploy on another HTTP server, please consult its documentation on how to achieve a similar result.

## Access to the API backend
There are 2 alternatives for the frontend application to access the Cyclos backend:

- Using CORS: The browser perform requests directly to the backend;
- Proxying the `api` directory: The HTTP server has a directory named `api` (must be this name!) proxying requests to the backend.

The CORS approach is faster / easier to deploy. In order for it to work, on the Cyclos backend's `cyclos.properties` file, set the `cyclos.cors.origin` to either `*` (any URL, not recommended for production) or to specific URLs (comma-separated list of allowed URLs). However, this approach has a drawback that before each actual request, the browser needs to send a preflight request, to ensure the actual request is allowed, because the Cyclos backend and the frontend run on different domains.

The second approach exposes a directory called `api` in the frontend application. For the browser, that directory is in the same domain as the frontend application itself. On the backend, the HTTP server (for example, Apache) will proxy all requests to `/api` to the Cyclos backend, which probably runs on the same server / datacenter. To do so, in Apache, make sure the `mod_proxy` and `mod_proxy_http` modules are enabled. Then apply the following configuration, replacing `http://localhost:8888/api` with the correct backend URL (don't forget to include the `/api` in the end):

```apache
<IfModule mod_proxy.c>
  ProxyPass "/api"  "http://localhost:8888/api"
  ProxyPassReverse "/api"  "http://localhost:8888/api"
</IfModule>
```

Alternatively, if the frontend is deployed in a sub path, the path must be specified:

```apache
<IfModule mod_proxy.c>
  ProxyPass "/path/api"  "http://localhost:8888/api"
  ProxyPassReverse "/path/api"  "http://localhost:8888/api"
</IfModule>
```

For other HTTP servers, please, consult their documentation on how to achieve the same result.

## Improving performance on the HTTP server
Angular generates some large, yet minified, JavaScript and CSS files. Two techniques can make loading the page much faster:

- Compression: Compresses the files when sending them to the client;
- Cache: Clients don't need to fetch again unchanged files.

These should be enabled on the web server. On Apache, the following configuration can be applied:

```apache
  <IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/javascript
  </IfModule>
  <IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/* "access plus 1 days"
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
  </IfModule>
```

It is safe to set a very large expiration date for CSS / JavaScript files because we explicitly enable the hashing on generated file names, making the file name change whenever the content changes.

## Generating links on the Cyclos backend that point to the frontend
Cyclos generates some links which are sent by e-mail to users. Examples include the e-mail to validate a registration, or some notification. It is desired that when the user clicks on such links, he is forwarded to the deployed front-end application, not to the Cyclos default web interface.

To achieve this, Cyclos allows using a script to generate links. As a global administrator (which may be switched to the network), in 'System > Tools > Script', create a script of type 'Link generation', with the following content:

```groovy
import org.cyclos.impl.utils.LinkType

if (user != null && user.admin) {
    // Don't generate custom links for admins
    return null
}

String root = scriptParameters.rootUrl
switch (type) {
    case LinkType.REGISTRATION_VALIDATION:
        return "${root}/users/validate-registration/${validationKey}"
    case LinkType.EMAIL_CHANGE:
        return "${root}/users/validate-email-change/${validationKey}"
    case LinkType.FORGOT_PASSWORD:
        return "${root}/forgot-password/${validationKey}"
    case LinkType.LOGIN:
        return "${root}/login"
}
// Other link types are not yet handled in the the frontend
```

Then, in 'System > System configuration > Configurations' select the configuration applied to users (or the default one) and mark the 'Link generation' field for customization. Then select the script you created and set the following as parameters, replacing the URL with your deployed URL:

```properties
rootUrl = https://account.example.com
```

## Translating
`TODO`